@startuml SignUpClassDiagram
skinparam classAttributeIconSize 0
Title SignUp Class Diagram
'Character	Visibility
'-			private
'#			protected
'~			package private
'+			public

'Extension	<|--	Quan hệ mở rộng từ (là extends hoặc implements nhưng ko có annotations trong code)
'Composition	*--	 Quan hệ gắn kết chặt chẽ : part - of
'Aggregation	o--	Quan hệ liên kết giữa hai thực thể : use, has

' Include các file vào trong file để sử dụng'

package pkgSignUp <<Frame>> {  
    'include controller'
    !includesub ../ControllersClassDiagram.plantuml!UsersController
    !includesub ../ControllersClassDiagram.plantuml!ControllerBase

    
    'include Repository'
    !includesub ../RepositoriesClassDiagram.plantuml!IRepositoryBase
    !includesub ../RepositoriesClassDiagram.plantuml!RepositoryBase
    !includesub ../RepositoriesClassDiagram.plantuml!DbContext
    !includesub ../RepositoriesClassDiagram.plantuml!InSyncContext
    !includesub ../RepositoriesClassDiagram.plantuml!IUserRepository
    !includesub ../RepositoriesClassDiagram.plantuml!UserRepository
    'include Dto'
    !includesub ../DtosClassDiagram.plantuml!ActionUserResponse
    !includesub ../DtosClassDiagram.plantuml!CreateUserDto
    !includesub ../DtosClassDiagram.plantuml!Verification
    !includesub ../DtosClassDiagram.plantuml!EmailAddresses
     !includesub ../DtosClassDiagram.plantuml!Data
    !includesub ../ModelsClassDiagram.plantuml!User

    ' Lớp chính để xử lý thay đổi mật khẩu
    class ClerkChangePassword {
    + startChangePassword(user: User): PasswordChangeSession
    + verifyOldPassword(user: User, oldPassword: string): boolean
    + updatePassword(user: User, newPassword: string): boolean
    + callWebhook(user: User): void
    }

    ' Lớp để xử lý phiên thay đổi mật khẩu
    class PasswordChangeSession {
    + id: string
    + status: PasswordChangeStatus
    + oldPassword: string
    + newPassword: string
    + isOldPasswordCorrect(): boolean
    + isNewPasswordValid(): boolean
    }

    ' Các trạng thái thay đổi mật khẩu
    class PasswordChangeStatus {
    <<enumeration>>
    + PENDING
    + COMPLETED
    + FAILED
    }

    ' Thông tin người dùng
    class UserClerk {
    + id: string
    + email: string
    + fullName: string
    + isVerified: boolean
    + password: string
    }

    



    'set up realation ship' 
    ControllerBase <|-- UsersController
    UsersController ..> ActionUserResponse : return views
    UsersController ..> CreateUserDto : request

    IRepositoryBase <|.. RepositoryBase
    IUserRepository <|.. UserRepository
    UserRepository o-- User

    IRepositoryBase <|-- IUserRepository 
    RepositoryBase <|-- UserRepository

    DbContext <|--InSyncContext
    RepositoryBase o-- InSyncContext
    UsersController o-- IUserRepository

    'Relationships
    Data "1" --> "*" EmailAddresses
    EmailAddresses "1" --> "1" Verification
    CreateUserDto "1" --> "1" Data



    ClerkChangePassword --> PasswordChangeSession
    PasswordChangeSession --> PasswordChangeStatus
    ClerkChangePassword --> UserClerk
    ClerkChangePassword --> UsersController : webhook
}

' Các bước quy trình thay đổi mật khẩu:
' Bắt đầu thay đổi mật khẩu:

' Người dùng yêu cầu thay đổi mật khẩu thông qua giao diện người dùng.
' Hệ thống gọi ClerkChangePassword.startChangePassword(user) để bắt đầu quy trình và tạo một phiên thay đổi mật khẩu (PasswordChangeSession).
' Xác minh mật khẩu cũ:

' Người dùng nhập mật khẩu cũ và mật khẩu mới.
' ClerkChangePassword.verifyOldPassword(user, oldPassword) được gọi để kiểm tra mật khẩu cũ.
' Nếu mật khẩu cũ đúng, quá trình tiếp tục.
' Nếu mật khẩu cũ sai, hệ thống sẽ thông báo lỗi và yêu cầu nhập lại.
' Cập nhật mật khẩu mới:

' Sau khi mật khẩu cũ được xác minh đúng, người dùng nhập mật khẩu mới.
' ClerkChangePassword.updatePassword(user, newPassword) được gọi để cập nhật mật khẩu mới cho người dùng.
' Gọi Webhook:

' Sau khi thay đổi mật khẩu thành công, ClerkChangePassword.callWebhook(user) được gọi để thông báo về việc thay đổi mật khẩu thành công, có thể thông qua một webhook đến hệ thống bên ngoài.